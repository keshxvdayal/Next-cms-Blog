import{useState as n,useEffect as e,useMemo as t,useSyncExternalStore as o,useCallback as i}from"react";let r;const s=new Uint8Array(16);function a(){if(!r&&(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!r))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(s)}const c=[];for(let n=0;n<256;++n)c.push((n+256).toString(16).slice(1));var d={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function u(n,e,t){if(d.randomUUID&&!e&&!n)return d.randomUUID();const o=(n=n||{}).random||(n.rng||a)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e){t=t||0;for(let n=0;n<16;++n)e[t+n]=o[n];return e}return function(n,e=0){return c[n[e+0]]+c[n[e+1]]+c[n[e+2]]+c[n[e+3]]+"-"+c[n[e+4]]+c[n[e+5]]+"-"+c[n[e+6]]+c[n[e+7]]+"-"+c[n[e+8]]+c[n[e+9]]+"-"+c[n[e+10]]+c[n[e+11]]+c[n[e+12]]+c[n[e+13]]+c[n[e+14]]+c[n[e+15]]}(o)}const f=["channel/disconnect","channel/response","channel/heartbeat"],l=["handshake/syn","handshake/syn-ack","handshake/ack"],p=n=>f.some((e=>e===n)),h=n=>l.some((e=>e===n)),y=({data:n={}})=>"object"==typeof n&&null!==n&&!Array.isArray(n)&&!("domain"in n)&&["id","type","from","to"].every((e=>e in n))&&n.type.startsWith("handshake/");function m(n){const e=window.self!==window.top||window.opener,t={buffer:[],id:null,origin:null,source:null,status:"connecting"};function o(e,o){if(h(e)||p(e)||"connecting"!==t.status&&"reconnecting"!==t.status){if(t.id&&t.origin&&t.source){const i={connectionId:t.id,data:o,domain:"sanity/channels",from:n.id,id:u(),to:n.connectTo,type:e};try{t.source.postMessage(i,{targetOrigin:t.origin})}catch(e){throw new Error("Failed to postMessage '".concat(i.id,"' on '").concat(n.id,"'"))}}}else t.buffer.push({type:e,data:o})}function i(e){var i;if(y(e))console.error("Visual editing package mismatch detected! Please ensure you are using the latest version of Sanity Studio and any packages listed here:\nhttps://github.com/sanity-io/visual-editing");else if(function(e){const{data:t}=e;return"sanity/channels"===t.domain&&t.to===n.id&&t.from===n.connectTo&&"channel/response"!==t.type}(e)){const{data:s}=e;if(t.origin&&e.origin!==t.origin)return;if(e.source&&t.source!==e.source&&(t.source=e.source),h(s.type)&&s.data){if("handshake/syn"===s.type)return t.origin=e.origin,t.id=s.data.id,r("connecting"),void o("handshake/syn-ack",{id:t.id});if("handshake/ack"===s.type&&s.data.id===t.id)return void r("connected")}else if(s.connectionId===t.id&&e.origin===t.origin){if("channel/disconnect"===s.type)return void r("disconnected");{const e=[s.type,s.data];null==(i=n.onEvent)||i.call(n,...e),o("channel/response",{responseTo:s.id})}return}}}function r(e){var i;t.status=e,null==(i=null==n?void 0:n.onStatusUpdate)||i.call(n,e),"connected"===e&&function(){const n=[...t.buffer];t.buffer.splice(0,t.buffer.length),n.forEach((({type:n,data:e})=>{o(n,e)}))}()}return window.addEventListener("message",i,!1),r("connecting"),{destroy:function(){["disconnected"].includes(t.status)||r("disconnected"),window.removeEventListener("message",i,!1)},inFrame:e,send:function(n,e){o(n,e)}}}function g(t,o,i){const[r,s]=n(),[a,c]=n(!1);e((()=>{if(window.self===window.top&&!window.opener)return;const n=m({id:"preview-kit",connectTo:"presentation",onStatusUpdate(n){"connected"===n?c(!0):"disconnected"===n&&c(!1)}}),e=setTimeout((()=>s(n)),0);return()=>{clearTimeout(e),n.destroy(),s(void 0)}}),[i,o]);const d=JSON.stringify(Array.from(t.keys()));e((()=>{"[]"!==d&&r&&a&&r.send("preview-kit/documents",{projectId:o,dataset:i,perspective:"previewDrafts",documents:Array.from(t.values())})}),[d,r,a,i,t,o])}function v(n){const e=t((()=>JSON.stringify(n||{})),[n]);return t((()=>JSON.parse(e)),[e])}function w(t){const{refreshInterval:r}=t,s=function(){const[t,i]=n(!1);e((()=>{i(navigator.onLine);const n=()=>i(!0),e=()=>i(!1);return window.addEventListener("online",n),window.addEventListener("offline",e),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",e)}}),[]);const r=o(k,(()=>document.visibilityState),(()=>"hidden"));return!t||"hidden"===r}(),[a,c]=n("hit"),d=i((()=>(c("inflight"),()=>c("hit"))),[]);return e((()=>{if(!r||"hit"!==a)return;const n=setTimeout((()=>c("stale")),r);return()=>clearTimeout(n)}),[r,a]),e((()=>{if("hit"!==a)return;const n=()=>c("stale");return window.addEventListener("focus",n),()=>window.removeEventListener("focus",n)}),[r,a]),e((()=>{s&&"hit"===a&&c("stale"),s||"stale"!==a||c("refresh")}),[s,a]),[a,d]}function k(n){return document.addEventListener("visibilitychange",n),()=>document.removeEventListener("visibilitychange",n)}export{g as useDocumentsInUse,v as useQueryParams,w as useRevalidate};//# sourceMappingURL=index.js.map
